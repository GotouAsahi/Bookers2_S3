<div class='container px-5 px-sm-0'>
  <div class='row'>
    <div class='col-md-3'>
      <h2>User info</h2>
      <%= render 'info', user: @user %>
      <h2 class="mt-3">New book</h2>
      <%= render 'books/form', book: @book %>
    </div>
    <div class='col-md-8 offset-md-1'>
      <h2>Books</h2>
      <%= render 'books/index',books: @books %>
      <div>
        <%= form_with url: user_search_path(@user), method: :post, local: false do |f| %>
          <%= f.date_field :created_at %>
          <%= f.submit '検索', class: 'btn btn-primary'  %>
        <% end %>
        <div class="search_result">
          <% if @search_book.present? %>
            <%= render 'search', search_book: @search_book %>
          <% end %>
        </div>
      </div>
      <h2>投稿数の前日比・前週比</h2>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>今日の投稿数</th>
            <th>昨日の投稿数</th>
            <th>前日比</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><%= @today_books.count %></td>
            <td><%= @yesterday_books.count %></td>
            <td>
              <% if @yesterday_books.count != 0 %>
                <% day_rate = @today_books.count / @yesterday_books.count.to_f %>
                <%= (day_rate * 100).round %>%
              <% else %>
                -
              <% end %>
            </td>
          </tr>
        </tbody>
      </table>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>今週の投稿数</th>
            <th>先週の投稿数</th>
            <th>前週比</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><%= @this_week_books.count %></td>
            <td><%= @last_week_books.count %></td>
            <td>
              <% if @last_week_books.count != 0 %>
                <% week_rate = @this_week_books.count / @last_week_books.count.to_f %>
                <%= (week_rate * 100).round %>%
              <% else %>
                -
              <% end %>
            </td>
          </tr>
        </tbody>
      </table>
      <canvas id="myChart"></canvas>
      <script src="//cdn.jsdelivr.net/npm/chart.js"></script>
    </div>
  </div>
</div>
<script>
  var ctx = document.getElementById('myChart');
  var myChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [
          <% for i in 0..5 %>
            '<%= 6-i %>日前',
          <% end %>
              '今日'
          ],
      datasets: [{
          label: '投稿した本の数',
          data: [
            <% for i in 0..6 %>
              <%= @books.created_day_before(6-i).count %>,
            <% end %>
          ],
          borderWidth: 1
      }]
      },
      options: {
        scales: {
          y:{
            min: 0,
            max: 10,
            ticks: {
              stepSize: 1
            }
          }
        }
      }
    });
</script>